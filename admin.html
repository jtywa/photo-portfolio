<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
		<title>Photo Admin</title>
		<link rel="stylesheet" href="admin.css" />
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
	</head>
	<body>
		<header class="header">
			<h3>Photo Admin</h3>
			<div id="auth">
				<div id="loggedIn" style="display: none">Logged in as Admin</div>
				<button id="login" onclick="netlifyIdentity.open()">Login</button>
				<button id="logoutBtn" style="display: none" onclick="netlifyIdentity.logout()">Logout</button>
			</div>
		</header>

		<!-- Instructions (hidden when logged in) -->
		<div id="instructions"><span>Log in to access admin features.</span></div>

		<!-- Admin Panel (hidden until logged in) -->
		<div id="adminPanel" style="display: none">
			<div id="container">
				<div id="uploadBar">
					<div>Upload New Photo</div>
					<input type="file" id="photoFile" />
					<select id="photoCategory">
						<option value="mountains">Mountains</option>
						<option value="sunsets">Sunsets</option>
					</select>
					<button id="uploadBtn">Upload</button>
				</div>
				<div id="existingPhotos">
					<div id="existingPhotosHeader">
						<h2>Existing Photos</h2>
						<select id="filterCategory">
							<option value="all">All Categories</option>
							<option value="mountains">Mountains</option>
							<option value="sunsets">Sunsets</option>
						</select>
					</div>

					<ul id="photoList"></ul>
				</div>
			</div>
		</div>
		<div id="toastContainer"></div>
		<script>
			// 🔐 Secure fetch wrapper
			async function secureFetch(url, options = {}) {
				const user = netlifyIdentity.currentUser();
				if (!user) throw new Error("Not logged in");

				const token = await user.jwt(); // Identity JWT
				return fetch(url, {
					...options,
					headers: {
						...(options.headers || {}),
						Authorization: `Bearer ${token}`, // attach token
					},
				});
			}

			// Show/hide admin panel based on login status
			netlifyIdentity.on("init", (user) => {
				if (user) {
					document.getElementById("adminPanel").style.display = "flex";
					document.getElementById("logoutBtn").style.display = "inline";
					document.getElementById("login").style.display = "none";
					document.getElementById("loggedIn").style.display = "inline";
					document.getElementById("instructions").style.display = "none";
					loadPhotos();
				} else {
					document.getElementById("adminPanel").style.display = "none";
				}
			});

			netlifyIdentity.on("login", (user) => {
				document.getElementById("adminPanel").style.display = "flex";
				document.getElementById("logoutBtn").style.display = "inline";
				document.getElementById("login").style.display = "none";
				document.getElementById("loggedIn").style.display = "inline";
				document.getElementById("instructions").style.display = "none";
				loadPhotos();
				netlifyIdentity.close();
			});

			netlifyIdentity.on("logout", () => {
				document.getElementById("adminPanel").style.display = "none";
				document.getElementById("logoutBtn").style.display = "none";
				document.getElementById("login").style.display = "inline";
				document.getElementById("loggedIn").style.display = "none";
				document.getElementById("instructions").style.display = "block";
			});

			// Load photos from GitHub
			async function loadPhotos() {
				const res = await secureFetch("/.netlify/functions/getPhotos");
				const photos = await res.json();
				const filter = document.getElementById("filterCategory").value;
				const list = document.getElementById("photoList");
				list.innerHTML = "";

				photos
					.filter((photo) => filter === "all" || photo.category === filter)
					.forEach((photo) => {
						const li = document.createElement("li");
						li.classList.add("image-container");
						li.innerHTML = `
              <img class="thumbnail" src="${photo.url}"/>
			  <i class="fa-solid fa-trash-can top-right-button" onclick="deletePhoto('${photo.url.split("/").pop()}')"></i>
            `;
						list.appendChild(li);
					});
			}

			// Delete photo
			async function deletePhoto(fileName) {
				if (!confirm(`Delete ${fileName}?`)) return;
				const res = await secureFetch("/.netlify/functions/deletePhoto", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ fileName }),
				});
				if (res.ok) {
					showToast("Photo deleted!", "success");
					loadPhotos();
				} else {
					showToast("Delete failed!", "error");
				}
			}

			// Upload photo
			document.getElementById("uploadBtn").onclick = () => {
				const file = document.getElementById("photoFile").files[0];
				const category = document.getElementById("photoCategory").value;
				if (!file) return showToast("Select a file!", "error");

				// 🔹 Show local preview immediately
				const previewUrl = URL.createObjectURL(file);
				const list = document.getElementById("photoList");
				const li = document.createElement("li");
				li.classList.add("image-container");
				li.innerHTML = `
    <img class="thumbnail" src="${previewUrl}"/> 
    <span>Uploading...</span>
  `;
				list.prepend(li);

				// Upload to GitHub
				const reader = new FileReader();
				reader.onloadend = async () => {
					const content = reader.result.split(",")[1]; // base64 without prefix
					const res = await secureFetch("/.netlify/functions/addPhoto", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							fileName: file.name,
							fileContent: content,
							category,
						}),
					});

					if (res.ok) {
						showToast("Photo uploaded!", "success");
						// Reload list after short delay so GitHub has time to serve the file
						setTimeout(loadPhotos, 3000);
					} else {
						showToast("Upload failed!", "error");
					}
				};
				reader.readAsDataURL(file);
			};

			function showToast(message, type = "success") {
				const container = document.getElementById("toastContainer");
				const toast = document.createElement("div");
				toast.className = `toast ${type}`;
				toast.textContent = message;

				container.appendChild(toast);

				// Trigger animation
				setTimeout(() => toast.classList.add("show"), 100);

				// Auto-remove after 3 seconds
				setTimeout(() => {
					toast.classList.remove("show");
					setTimeout(() => toast.remove(), 300);
				}, 3000);
			}

			document.getElementById("filterCategory").onchange = loadPhotos;
		</script>
	</body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<title>Photo Admin</title>
		<link rel="stylesheet" href="admin.css" />
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
	</head>
	<body>
		<header class="header">
			<h3>Photo Admin</h3>
			<div id="auth">
				<button id="loginLogout" onclick="netlifyIdentity.open()">Login / Logout</button>
				<button id="logoutBtn" style="display: none" onclick="netlifyIdentity.logout()">Logout</button>
			</div>
		</header>

		<!-- Login/Logout UI -->

		<!-- Admin Panel (hidden until logged in) -->
		<div id="adminPanel" style="display: hidden">
			<div id="container">
				<div id="uploadBar">
					<div>Upload New Photo</div>
					<input type="file" id="photoFile" />
					<select id="photoCategory">
						<option value="mountains">Mountains</option>
						<option value="sunsets">Sunsets</option>
					</select>
					<button id="uploadBtn">Upload</button>
				</div>
				<div id="existingPhotos">
					<div id="existingPhotosHeader">
						<h2>Existing Photos</h2>
						<select id="filterCategory">
							<option value="all">All Categories</option>
							<option value="mountains">Mountains</option>
							<option value="sunsets">Sunsets</option>
						</select>
					</div>

					<ul id="photoList"></ul>
				</div>
			</div>
		</div>

		<script>
			// 🔐 Secure fetch wrapper
			async function secureFetch(url, options = {}) {
				const user = netlifyIdentity.currentUser();
				if (!user) throw new Error("Not logged in");

				const token = await user.jwt(); // Identity JWT
				return fetch(url, {
					...options,
					headers: {
						...(options.headers || {}),
						Authorization: `Bearer ${token}`, // attach token
					},
				});
			}

			// Show/hide admin panel based on login status
			netlifyIdentity.on("init", (user) => {
				if (user) {
					document.getElementById("adminPanel").style.display = "hidden";
					// document.getElementById("logoutBtn").style.display = "inline";
					document.getElementById("loginLogout").style.display = "inline";
				}
			});

			netlifyIdentity.on("login", (user) => {
				document.getElementById("adminPanel").style.display = "flex";
				document.getElementById("logoutBtn").style.display = "inline";
				document.getElementById("loginLogout").style.display = "hidden";
				netlifyIdentity.close();
			});

			netlifyIdentity.on("logout", () => {
				document.getElementById("adminPanel").style.display = "none";
				document.getElementById("logoutBtn").style.display = "none";
				document.getElementById("loginLogout").style.display = "inline";
			});

			// Load photos from GitHub
			async function loadPhotos() {
				const res = await secureFetch("/.netlify/functions/getPhotos");
				const photos = await res.json();
				const filter = document.getElementById("filterCategory").value;
				const list = document.getElementById("photoList");
				list.innerHTML = "";

				photos
					.filter((photo) => filter === "all" || photo.category === filter)
					.forEach((photo) => {
						const li = document.createElement("li");
						li.classList.add("image-container");
						li.innerHTML = `
              <img class="thumbnail" src="${photo.url}"/> 
              <button class="top-right-button" onclick="deletePhoto('${photo.url.split("/").pop()}')">Delete</button>
            `;
						list.appendChild(li);
					});
			}

			// Delete photo
			async function deletePhoto(fileName) {
				if (!confirm(`Delete ${fileName}?`)) return;
				const res = await secureFetch("/.netlify/functions/deletePhoto", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ fileName }),
				});
				if (res.ok) {
					alert("Photo deleted!");
					loadPhotos();
				} else {
					alert("Delete failed!");
				}
			}

			// Upload photo
			document.getElementById("uploadBtn").onclick = () => {
				const file = document.getElementById("photoFile").files[0];
				const category = document.getElementById("photoCategory").value;
				if (!file) return alert("Select a file!");

				const reader = new FileReader();
				reader.onloadend = async () => {
					const content = reader.result.split(",")[1]; // base64 without prefix
					const res = await secureFetch("/.netlify/functions/addPhoto", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							fileName: file.name,
							fileContent: content,
							category,
						}),
					});
					if (res.ok) {
						alert("Photo uploaded!");
						loadPhotos();
					} else {
						alert("Upload failed!");
					}
				};
				reader.readAsDataURL(file);
			};

			// Load photos when page opens
			loadPhotos();
			document.getElementById("filterCategory").onchange = loadPhotos;
		</script>
	</body>
</html>
